# План рефакторинга и улучшения архитектуры FitMetrics (Mobile)

## 1. Общая концепция
Текущая архитектура проекта имеет хорошую базу (Monorepo, разделение на фичи), но экраны (`screens`) перегружены логикой и версткой.
Цель рефакторинга: внедрение модульной архитектуры (на базе **Feature-Sliced Design**) для улучшения читаемости, тестируемости и поддержки.

**Принцип разделения ответственности:**
*   **UI (Components):** "Глупые" компоненты, отвечающие только за отображение. Получают данные через props. Не знают о API.
*   **Model (Hooks/State):** Бизнес-логика, работа с API, состояние, валидация форм.
*   **Lib/Utils:** Чистые функции (форматирование дат, чисел, обработка строк).
*   **Screens:** Контейнеры, которые собирают компоненты и подключают к ним хуки с логикой.

---

## 2. Feature: Diary (Дневник)
*Текущее состояние:* Монолитный `DiaryScreen.tsx` (1000+ строк), смешивающий UI, стили и логику синхронизации.

**Статус:** выполнено (экран разбит на компоненты, логика вынесена в хуки, календарная логика в shared).

### Рекомендуемая структура (`features/diary/`)
```text
features/diary/
├── components/
│   ├── MealItem.tsx           # Карточка приема пищи (со свайпами)
│   ├── MacroCard.tsx          # Карточка БЖУК (кольца прогресса)
│   ├── WeekProgressBorder.tsx # UI элемент календаря
│   └── DailySurveyButton.tsx  # Кнопка/статус анкеты
├── model/
│   ├── useDiaryData.ts        # Загрузка и локальное управление состоянием
│   ├── useDiarySync.ts        # Логика синхронизации с бэкендом
│   └── useWeekCalendar.ts     # Логика переключения дат и свайпов недели
├── screens/
│   └── DiaryScreen.tsx        # Сборка экрана
└── index.ts                   # Public API фичи
```

---

## 3. Feature: Measurements (Замеры)
*Задачи:* Управление историей замеров, ввод новых данных, работа с фото (камера/галерея), графики прогресса.

**Статус:** выполнено (вынесены UI-компоненты, форма, графики; добавлены `useMeasurementsList` и `usePhotoUpload`).

**Доп. пункт:** экран Analytics удалён (графики перенесены в основной экран замеров).

### Проблемы для предотвращения
1.  Логика `ImagePicker` (права доступа, выбор, сжатие) часто загромождает код экрана.
2.  Валидация формы (числа, диапазоны) смешивается с версткой.
3.  Графики могут вызывать лишние перерисовки всего экрана.

### Рекомендуемая структура (`features/measurements/`)
```text
features/measurements/
├── components/
│   ├── MeasurementHistoryItem.tsx  # Карточка в списке истории (дата + миниатюры)
│   ├── MeasurementForm.tsx         # Форма ввода (грудь, талия, бедра и т.д.)
│   ├── PhotoPickerSlot.tsx         # Компонент слота фото (Фронт/Бок/Спина)
│   └── MeasurementChart.tsx        # График прогресса (изолированный компонент)
├── model/
│   ├── useMeasurementsList.ts      # Получение истории замеров
│   ├── useMeasurementForm.ts       # Логика формы, валидация (Zod), сохранение
│   └── usePhotoUpload.ts           # Логика работы с медиа и загрузкой на сервер
├── screens/
│   ├── MeasurementsListScreen.tsx  # Экран истории и графиков
│   └── AddMeasurementScreen.tsx    # Экран добавления (или модалка)
└── index.ts
```

---

## 4. Feature: Profile (Профиль)
*Задачи:* Отображение данных пользователя, редактирование, смена пароля, управление связью с тренером (инвайты), выход.

**Статус:** выполнено (выделены компоненты, логика вынесена в хуки).

### Проблемы для предотвращения
1.  Смешивание режимов "Просмотр" и "Редактирование" в одном большом компоненте.
2.  Логика инвайт-кодов требует обработки ошибок API и состояний загрузки.
3.  Логика `Logout` должна быть переиспользуемой (например, при истечении токена).

### Рекомендуемая структура (`features/profile/`)
```text
features/profile/
├── components/
│   ├── ProfileHeader.tsx       # Аватар, Имя, краткая сводка
│   ├── TrainerCard.tsx         # Информация о тренере (статус связи)
│   ├── SettingsMenu.tsx        # Список действий (Сменить пароль, Выйти)
│   └── EditProfileForm.tsx     # Форма редактирования (Имя, Рост, Вес)
├── model/
│   ├── useUserProfile.ts       # Получение и обновление данных
│   ├── useTrainerConnection.ts # Логика ввода инвайт-кода и смены тренера
│   └── useAuthActions.ts       # Логика Logout, ChangePassword
├── screens/
│   └── ProfileScreen.tsx
└── index.ts
```

---

## 5. Shared Layer (Общее)
Код, который используется в двух и более фичах, должен быть вынесен в `shared`.

**Статус:** частично выполнено (`shared/lib/date` готов, календарь в shared).

**Доп. пункт:** добавлена локальная валидация данных по `user_id` (SQLite + хранение user id в app_state/secure storage).

### Кандидаты на вынос (из DiaryScreen и других мест)

1.  **Date Utils** -> `shared/lib/date/index.ts`
    *   `getDateObj`, `formatDateKey`, `shiftDate` (сейчас дублируются или жестко зашиты).
    *   Используются в: Дневнике, Замерах, Анкетах.

2.  **UI Kit** -> `shared/ui/`
    *   `AppButton`, `AppInput`, `Card` — базовые стилизованные компоненты для единообразия дизайна.
    *   `Loader` — индикатор загрузки.
    *   `ErrorMessage` — стандартизированный вывод ошибок.

3.  **Media Utils** -> `shared/lib/media/`
    *   Обертки над `expo-image-picker` для запроса прав и обработки результатов.

---

## 6. План действий (Roadmap)

1.  [x] **Shared:** Создать `shared/lib/date` и перенести туда утилиты из `DiaryScreen`.
2.  [x] **Diary Refactor:** Разбить `DiaryScreen` на компоненты (`MealItem`, `MacroCard`) и хуки.
3.  [x] **Measurements:** Реализовать структуру с отделением логики фото (`usePhotoUpload`) и дожать структуру списка.
4.  [x] **Profile:** Реализовать структуру с отделением логики тренера (`TrainerCard` + `useTrainerConnection`).
5.  [x] **Testing:** Написать unit-тесты для вынесенных хуков (model) и утилит (lib).

---

## 7. Стратегия миграции
Рефакторинг делаем поэтапно, без массовой переписи:
1.  Разбиваем экраны на компоненты и хуки внутри фичи.
2.  Переносим общие утилиты и UI‑элементы в `shared`.
3.  Поддерживаем обратную совместимость до полного переноса логики.
4.  Закрываем миграции по одной фиче за раз (Diary → Measurements → Profile).

---

## 8. Выполнено вне плана
1.  Двусторонняя синхронизация дневника (добавлен pull с сервера).
2.  Привязка локальных данных к `user_id` (защита от смешивания пользователей).
3.  Удаление экрана Analytics (графики теперь в основном экране замеров).

## 9. Тесты (выполнено)
Покрыты: `shared/lib/date`, `buildLinePath`, `useMeasurementsData`, `useDiarySync`, `useUserProfile`, `userSession`.

## 10. Осталось по плану
1.  **Shared UI kit** (`shared/ui`): `AppButton`, `AppInput`, `Card`, `Loader`, `ErrorMessage`.
2.  **Media utils** (`shared/lib/media`): обертки над `expo-image-picker`.
3.  **Public API** для фич (`index.ts`) — добавить там, где отсутствует.
4.  **Актуализация структуры Measurements:** в плане `MeasurementsListScreen`/`AddMeasurementScreen`, сейчас один экран + модалка — либо обновить план, либо разнести экраны.
